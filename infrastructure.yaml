tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/5.2.2/types.yaml
  - plugin:cloudify-terraform-plugin


inputs:

  vm_name:
    type: string

  num_cpus:
    type: integer
    description: >
      Number of CPU cores
    default: 1

  memory_size:
    type: integer
    description: >
      Size of the RAM memory (in MB)
    default: 1024

  disk_size:
    type: integer
    description: >
      Size of the disk storage (in GB)
    default: 32

  network:
    type: string
    description: >
      Name of the internal vSphere network
    default: Internal

  template_name:
    type: string
    description: >
      Name of the CentOS template
    default: { get_secret: centos_template }


node_templates:

  terraform_executable:
    type: cloudify.nodes.terraform
    properties:
      resource_config:
        installation_source: https://releases.hashicorp.com/terraform/0.14.6/terraform_0.14.6_linux_amd64.zip

  infrastructure:
    type: cloudify.nodes.terraform.Module
    properties:
      resource_config:
        variables:
          vsphere_server:
            concat:
              - { get_secret: vsphere_host }
              - ':'
              - { get_secret: vsphere_port }
          vsphere_user: { get_secret: vsphere_username }
          vsphere_password: { get_secret: vsphere_password }
          vsphere_datacenter: { get_secret: vsphere_datacenter_name }
          vsphere_datastore: { get_secret: vsphere_datastore_name }
          vsphere_resource_pool: { get_secret: vsphere_resource_pool_name }
          vsphere_network: { get_input: network }
          vm_name: { get_input: vm_name }
          num_cpus: { get_input: num_cpus }
          memory_size: { get_input: memory_size }
          disk_size: { get_input: disk_size }
          template_name: { get_input: template_name }
        source:
          location: https://github.com/Cloudify-PS/wwt-training-demo/archive/refs/heads/tf.zip
          username: { get_secret: github_username }
          password: { get_secret: github_password }
    relationships:
      - target: terraform_executable
        type: cloudify.terraform.relationships.run_on_host
 

capabilities:

  vm_ip:
    description: IP address of the centos vm
    value: { get_attribute: [infrastructure, state, vm, instances, 0, attributes, default_ip_address] }

  vm_user:
    description: Username for logging in the VM
    value: { get_secret: centos_default_username }
  
  vm_password:
    description: Password for logging in the VM
    value: { get_secret: centos_default_password }
